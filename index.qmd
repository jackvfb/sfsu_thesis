---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
#| output: false


library(identidrift)
library(tidyverse)
library(PAMpal)
library(banter)
library(rfPermute)
library(knitr)
library(densityClust)
library(ggtext)
```

## Results {.unnumbered}

### Click detection and event definition

From an initial set of 26,357 distinct detections, the recordings in the training set yielded 78 events containing a total of 3,994 distinct detections (@tbl-ndets). Harbor porpoise contributed the most events and detections to the training set, outnumbering both *Kogia* spp. and Dall’s porpoise which were roughly equal. A differing proportion of data was dropped in each class and was highest for Dall’s porpoise (99%). 

```{r}
#| label: tbl-ndets
#| tbl-cap: "Representation of each class in the training set: $n_i$ initial quantity of distinct detections, prior to event definition; $n_f$ final quantity of detections, i.e. detections included in events; $n$ events number of distinct events."

data(templ.match)
templ.match <- ungroup(templ.match)

t <- templ.match %>%
  left_join(select(train.ec, UID, eventId), by = "UID")

t_tot <- t %>% 
  summarize(n_initial = sum(is.na(eventId)),
            n_final = sum(!is.na(eventId)),
            n_ev = n_distinct(eventId, na.rm = TRUE)) %>%
  mutate(species = "Total")

t_sp <- t %>%
  group_by(species) %>% 
  summarize(n_initial = sum(is.na(eventId)),
            n_final = sum(!is.na(eventId)),
            n_ev = n_distinct(eventId, na.rm = TRUE))

rbind(t_tot, t_sp) %>% 
  arrange(n_final) %>%
  select(species, n_initial, n_final, n_ev) %>% 
  rename("$n_i$ detections" = n_initial,
         "$n_f$ detections" = n_final,
         "$n$ events" = n_ev) %>%
  mutate(species = case_match(species,"ks" ~ "*Kogia* spp.",
                              "pd" ~ "Dall's porpoise",
                              "pp" ~ "harbor porpoise",
                              .default = species)) %>% 
  kable()
```

### Features

```{r}
#| output: false

varsWanted <- c("BW_3dB", "BW_10dB", "centerkHz_3dB", "centerkHz_10dB", "duration",
                "fmax_10dB", "fmax_3dB", "fmin_3dB", "fmin_10dB", "peak", "Q_3dB",   
                 "Q_10dB")

stats <- train.ec %>%
   select(species, all_of(varsWanted)) %>%
   pivot_longer(cols=-species, names_to = "var") %>%
   group_by(species, var) %>%
   summarize(mean=mean(value), sd=sd(value), median=median(value),
             min=min(value), max=max(value)) %>%
   mutate_if(is.numeric, round, 2) %>%
   nest(data=-var) %>%
   mutate(data=map(data, \(x) as.matrix(column_to_rownames(x, var="species")))) %>%
   pull(data, name = "var")

mean_sd <- function(m, sp) {
  paste0(m[sp, "mean"], " (", m[sp, "sd"], ")")
}
```

Summary statistics for click features extracted by *PAMpal* are given in @tbl-sumstats. From least to greatest, *Kogia* spp., Dall's porpoises, and harbor porpoises produced click peak frequencies of `{r} mean_sd(stats$peak, "ks")`, `{r} mean_sd(stats$peak, "pd")`, `{r} mean_sd(stats$peak, "pp")`, respectively. This ranking was preserved with respect to the related features center, maximum, and minimum frequencies at both -3 dB and -10 dB. With respect to bandwidths, *Kogia* spp. produced the greatest mean values at both -3 dB and -10 dB.

```{r}
#| label: tbl-sumstats
#| tbl-cap: "Summary statistics of acoustic features for each species class, given as mean \u00b1 standard deviation. The abbreviated name for the feature is given underneath in parenthesis, where needed."
#| message: false

train.ec %>%
  select(species, all_of(varsWanted)) %>%
  pivot_longer(cols=-species, names_to = "var") %>%
  group_by(species, var) %>%
  summarize(mean=mean(value), sd=sd(value)) %>% 
  mutate_if(is.numeric, round, 2) %>%
  mutate(entry=str_c(mean, "<br>\u00b1 ", sd)) %>%
  select(species, var, entry) %>%
  mutate(species = case_match(species,
                              "ks" ~ "*Kogia* spp.",
                              "pd" ~ "Dall's porpoise",
                              "pp"~ "harbor porpoise"),
         var = case_match(var,
                          "BW_10dB" ~ "Bandwidth -10 dB",
                          "BW_3dB" ~ "Bandwidth -3 dB",
                          "Q_10dB" ~ "Q factor -10 dB",
                          "Q_3dB" ~ "Q factor -3 dB",
                          "centerkHz_10dB" ~ "Center freq -10 dB<br> ($f_{center}^{-10dB}$)",
                          "centerkHz_3dB" ~ "Center freq -3 dB<br> ($f_{center}^{-3dB}$)",
                          "fmax_10dB" ~ "Max freq -10 dB<br> ($f_{max}^{-10dB}$)",
                          "fmax_3dB" ~ "Max freq -3 dB<br> ($f_{max}^{-3dB}$)",
                          "fmin_10dB" ~ "Min freq -10 dB<br> ($f_{min}^{-10dB}$)",
                          "fmin_3dB" ~ "Min freq -3 dB<br> ($f_{min}^{-3dB}$)",
                          "duration" ~ "Duration",
                          "peak" ~ "Peak freq<br> ($f_{peak}$)")) %>%
  pivot_wider(names_from = var, values_from = entry) %>%
  column_to_rownames("species") %>%
  t() %>%
  kable(align="c")
```

The concatenated spectrograms in @fig-concatspec exhibited lateral darkening in bands, showing that the region of highest energy was well defined in the majority of the clicks comprising each class in the training set. With clicks sorted by peak frequency, as shown, a slight incline was introduced to the lateral band indicating that there were fluctuations in peaks. 

The averaged spectra in @fig-concatspec displayed unique geometry. *Kogia* spp. (@fig-concatspec, B) was descriptively more symmetrical and smoothed. Dall’s porpoise (@fig-concatspec, D) and harbor porpoise (@fig-concatspec, F) had notches and shoulders at frequencies below peak. The frequency values at which the peaks and notches occurred, as well as the bandwidth of the spectra at different levels of intensity, clearly differed between each class.

!["Concatenated spectrograms (Left side) and averaged spectra (Right side) for each of the three classes in the training set: *Kogia* spp. (A, B), Dall's porpoise (C, D), and harbor porpoise (E, F)."](fig_img/concatspec.png){#fig-concatspec}

### Clustering

Density clustering formed three clusters when setting $\rho$ = 25 and $\delta$ = 2 (@fig-clusters). The number of clusters could be increased by lowering these values, but in these scenarios at least one cluster contained less than five clicks. The chosen solution therefore provided the greatest number of clusters such that each cluster was populated with a non-negligible number of clicks. Regardless of how many clusters were formed, it was clear that each species distributed across multiple clusters. The counts for each species are shown (normalized) in each cluster in in @tbl-clust-assn.

!["Density clustering solution calculated using Euclidean distances between clicks with non-parametric features log-transformed. The bottom panel shows the three clusters represented in the first two dimensions of feature space, colored separately. The upper left panel shows the cluster center points that were captured when setting $\rho$ = 25 and $\delta$ = 2. The upper right panel shows $\gamma$, the product of $\rho$ and $\delta$. Each cluster contained clicks from all three species classes."](fig_img/clusters.png){#fig-clusters}

```{r}
#| label: tbl-clust-assn
#| tbl-cap: "Table of cluster assignments. Each cell shows the proportion of clicks in each class that were assigned to the cluster."

samp_clust <- readRDS("samp_clust.rds")
samp_clust %>%
  count(species, clust) %>%
  mutate(tot = sum(n), .by=species) %>%
  mutate(prop = round(n/tot, 2)) %>%
  select(species, clust, prop) %>%
  pivot_wider(names_from = clust, values_from = prop) %>%
  rename("Cluster 1" = `1`,
         "Cluster 2" = `2`,
         "Cluster 3" = `3`,) %>%
  mutate(species = case_match(species,
                              "ks" ~ "*Kogia* spp.",
                              "pd" ~ "Dall's porpoise",
                              "pp"~ "harbor porpoise")) %>%
  kable()
```

### Click classification

Next, random forests were trained to classify clicks. Two models were developed 1) with species as the response variable and 2) with cluster as the response variable. The species classifier resulted in 88.4% accuracy with the three most important predictors $f_{max}^{-10dB}$, $f_{center}^{-10dB}$, and $f_{min}^{-10dB}$. The cluster classifier resulted in 98.5% accuracy with the three most important predictors $f_{max}^{-3dB}$, $f_{min}^{-3dB}$, and $f_{min}^{-10dB}$. 

### Event classification

```{r}
bant <- readRDS("models/bant.rds")
```

The call classifiers composing the first stage of the BANTER model showed that overall performance was highest for middle clicks (86%), and about equal for low and high clicks (68%) (@tbl-mdlcorr). None exceeded 88% which was the accuracy of the call classifier trained on the undivided click set.

At the event level, the BANTER model correctly classified 88% of all events (@tbl-mdlcorr). Accuracy was lowest for harbor porpoise (85%) and highest for both Dall’s porpoise (93%) and *Kogia* spp. (93%). Accuracy in all three classes was greater than what was expected due to chance. The top three of the ten most important event predictors were the mean probability values of 1) middle clicks assigned to Dall’s porpoise 2) middle clicks assigned to harbor porpoise, 3) low clicks assigned to *Kogia* spp. (@fig-bantimp).

The proximity plot clustered events (@fig-bantprox, points) into non-overlapping regions (@fig-bantprox, shaded areas) inside of which virtually all of events were correctly classified, as indicated by the color of the ring around each point matching the color of its center point. For events not closely associated with the cluster core, of which there appeared to be few, model misclassification was more prevalent.

```{r}
#| label: tbl-mdlcorr
#| tbl-cap: Species and overall accuracies of event classifier and the three call classifiers composing it. "Low click" classifier was trained on clicks where $100 \leq f_{peak} < 120$, "middle click" where $120 \leq f_{peak} < 140$, and "high click" where $140 \leq f_{peak} \leq 160$.
#| warning: false

modelPctCorrect(bant) %>%
  mutate(species = case_match(species,"ks" ~ "*Kogia* spp.",
                              "pd" ~ "Dall's porpoise",
                              "pp" ~ "harbor porpoise",
                              .default = species)) %>%
  rename("low click" = lorange,
         "middle click" = midrange,
         "high click" = hirange) %>% 
  kable()
```

```{r}
#| label: fig-bantimp
#| fig-cap: Heat map showing the ten most important predictors for the random forest that classifies events. The name of the predictor is on the left, and the color of the cell indicates the rank.

plotImportance(getBanterModel(bant), plot.type="heatmap")

```

```{r}
#| label: fig-bantprox
#| fig-cap: Proximity plot showing the events in feature space, represented by points, with the circle around each point representing the model's resultant classification. The shaded regions represent the cluster associated with each class.

plotProximity(getBanterModel(bant))
```

###	Survey data collection and model predictions

The PAM survey data employed for predictions yielded a total post-event definition of 102,464 detections distributed across 1,946 events. The overall proportion of events classified as each species across the entire survey was ~4%, 27%, 69% for *Kogia* spp., harbor porpoise, and Dall’s porpoise, respectively. @fig-driftpred shows that the number of events as well as the frequency of predictions for each species varied among drifts. The total events in each drift ranged from 2 - 291 and the proportion of predictions for each species, given as the IQR, was 0.5-6%, 2-24%, 70-91,%  for *Kogia* spp., harbor porpoise, and Dall’s porpoise respectively. When split by depth, it was found that events that occurred in waters less than 200 m deep had a greater proportion of harbor porpoise predictions relative to all other events.

```{r}
#| label: fig-driftpred
#| fig-cap: "Predicted classifications, by drift, arranged in order of increasing latitude from left to right. The height of each bar represents the total number of events defined in each drift. The bars are colored based on the proportion of events classified as each species."

drifts <- readRDS("drifts.rds")
drifts %>%
  group_by(db) %>%
  mutate(db_lat = round(median(Latitude), 2)) %>%
  ggplot() +
  geom_bar(aes(x=fct_reorder(db, db_lat),
               fill=predicted)) +
  theme(axis.text.x = element_text(angle=45))+
  xlab("Drift name")+
  ylab("Number of events")+
  scale_fill_discrete(breaks = c("ks", "pd", "pp"),
                       labels = c("*Kogia* spp.", "Dall's porpoise", "harbor porpoise"))+
  theme(legend.text = element_markdown())
```

## Discussion {.unnumbered}

By taking a supervised approach, using ground-truth data to train a classifier, our approach generated from raw acoustic recordings a set of temporally and spatially defined events, with associated species classifications with high confidence in their classification derived by taking into consideration not only the degree to which the clicks in the event resemble each species, but also the distribution of those differences within an individual grouping of clicks, an event. Through considering both the click and the event layer, as well as taking a supervised classification approach, this research revealed new uncertainties while addressing others, the principal source of uncertainty and ambiguity that was left unresolved after earlier attempts to classify NBHF signals in CCS.

At the click level, comparisons between species in the mean click features, concatenated spectrograms and average spectra suggests that on average, each species emits clicks with energy focused at different mean frequencies. Mean values did map onto previously reported by Griffiths. Though Kogia at the lowest frequency, harbor porpoise at the highest, Dall’s intermediate was an ordination that played out in various respects. Visually, it was evident from comparing the spectral profiles, observing shifts in their peaks and elevated energy regions, as well as in the concatenated spectrogram. It was also evident from the most important predictors that emerged from random forest classifiers, which identified center and peak frequencies as maintaining high importance across all classes. Also evident from a simple click classifier which classified overall 89% of clicks correctly, in which the most important predictors were X, Y, Z. How did these features compare to other studies?

However it is important to understand that the picture that emerged from the average across the entirety of our data set was not necessarily indicative of the relationship that existed between individual click samples in all cases and still evidenced high degree of overlap. This was illustrated in part because of the large spread around the central measures in our feature space for each class, also demonstrated by deficiency in the classifier. Explanations for this confounding influences are A, B, C.

In fact unsupervised clustering distributed clicks across three clusters (or more) clusters whose acoustic features could be used to predict cluster association with higher accuracy than the true species identify, showing that associations between clicks in feature space was not just related to species identity but likely to other factors as well such as A,B,C. , clarifying the existence of acoustic overlap. With our cluster classifier operating better than our species classifier, and on par with Griffiths et all classifier trained from unsupervised classes, we were able to show with groud-truth data interpretations based strictly on unsupervised clustering, should be interpreted cautiously as being representative individual species.

One possibility for how to improve this would be to determine whether there are patterns that emerge when considering events rather than individual clicks as the unit of classification, which was the main driver of our study novelty and contribution. This was the original intent of employing BANTER. This has been shown to improve classification accuracy in delphinids essentially because there are characteristic distributions of classification and misclassification that are in fact unique to each species class and was thought to be a viable improvement in NBHF. Our investigation of this revealed that NBHF events could be classified at the event level with 88.7% accuracy by taking into consideration the mean patterns of distribution across all the call types, a result that does not appear to be better than the result we get from classifying strictly based on clicks. Suggesting that event classification, while on par with click classification, may not actually reduce uncertainty associated with acoustic overlap.

Despite the equivalent accuracy, however, defining events instead of clicks presents an opportunity to introduce more sophistication into the classification process, and potentially more room to improve beyond click classification. We introducing a match score template matching process and scripting to define events based on other parameters, however there are conceivably many other ways of doing this, for example A, B, C. And we acknowledge that our method for defining events, which is vital to the overall results of our classification, could conceivably be improved. Indeed, there are concerns surrounding the way in which we defined events which could be limiting the accuracy that we are achieving with our BANTER model. The relatively large proportions of the data dropped from each database in the training set, which despite the known presence of animals during the recordings, was as high as 70-99%. This suggests low recall, i.e. fewer events being defined that what was expected. Low recall is a presumably a problem not only because it would act to falsely diminish acoustic density/presence in survey data (and consequently, the downstream products such as population stock estimates but also because it restricts the range of conditions and variation on which the classifier was trained. Working to further refine event definition, such as through expanding the number of templates, through obtaining ground-truth recordings with a greater range of observed features (e.g. range to animal, number of animals, orientation of animal), considering dBPP should continue to be explored with the potential of improving event definition and resultant classification accuracy.

Despite the potential flaws in event definition, and the limits it may have imposed on our classification accuracy, the survey data set revealed a rich data set with an abundance of events across the survey area which broadly painted the picture that all species are present in our region but possible in different spatial patterns and overall proportions. While no steps were taken to effectively model these distributions, overall summary statistics revealed that some species are more prevalent than others and that, as expected, harbor porpoise more common in shallow depths.

In conclusion, our process for defining events, designed to be a quick and expedient for identity good matches from among a large body of detections, was sufficient to reveal very important dimensions of the relationship between these different species, as well as to identify a rich set of events from the survey data.  Revealing that despite mean characteristics that tend to differ between NBHF species, there exists substantial overlap that would obscure the classification accuracy of a click classifier alone. Layering event classification over click classification with ML resolves this ambiguity to improve classification in a functional manner across data sets of large magnitude.
